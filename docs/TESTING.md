# テスト文書

## 概要

このドキュメントでは、AIチャットアプリケーションのテスト戦略と実装について説明します。

## テスト構成

### テスト環境設定
- **フレームワーク**: Vitest with React Testing Library
- **環境**: DOM シミュレーション用 jsdom
- **設定**: React プラグインとパスエイリアス付きの `vitest.config.ts`
- **セットアップファイル**: グローバルテスト設定用 `client/src/test/setup.ts`

### テストカテゴリ

#### 1. フロントエンドコンポーネントテスト (`client/src/test/components/`)

**ChatMessage コンポーネント** (`chat-message.test.tsx`)
- ユーザーとAIメッセージの正しいレンダリング
- 適切なスタイリングと配置の適用
- コードブロックと複数行メッセージの処理
- 正しいタイムスタンプの表示

**ChatInput コンポーネント** (`chat-input.test.tsx`)
- メッセージ入力と送信の処理
- キーボードショートカットのサポート (Enter、Shift+Enter)
- テキストエリアの自動リサイズ
- 空メッセージ・空白文字のみメッセージの検証
- 送信後のフォーカス維持

**FontSelector コンポーネント** (`font-selector.test.tsx`)
- 全フォントオプションの表示
- 選択されたフォントの正しい表示
- フォント変更ハンドラーの呼び出し
- ドキュメントへのフォントクラスの適用

#### 2. バックエンドAPIテスト (`server/test/`)

**ルートテスト** (`routes.test.ts`)
- メッセージの取得と作成
- AI サービス統合 (Ollama/LM Studio)
- 異なるサービスのモデル一覧
- 設定管理
- エラーハンドリング

**ストレージテスト** (`storage.test.ts`)
- ユーザー操作（作成、取得）
- チャットメッセージ操作
- 設定管理
- データ永続化と増分ID

## テストの実行

### コマンド
```bash
# 全テストを一度実行
npx vitest run

# ウォッチモードでテスト実行
npx vitest

# UIモードでテスト実行
npx vitest --ui
```

### テストカバレッジ領域

#### ✅ 実装済み
- コンポーネントのレンダリングとインタラクション
- APIエンドポイントの機能
- データストレージ操作
- エラーハンドリング
- フォームバリデーション
- ユーザー入力処理

#### 🔄 進行中
- 統合テスト
- E2Eテストシナリオ
- パフォーマンステスト

## テストデータ戦略

### モックデータ
- 実際のAPIレスポンスに一致するリアルなテストデータを使用
- フロントエンドとバックエンドテスト間でのデータ一貫性維持
- エッジケースを含む（空メッセージ、長いコンテンツ、特殊文字）

### APIモッキング
- 外部AIサービス呼び出しのモック（Ollama、LM Studio）
- ネットワークエラーとタイムアウトのシミュレーション
- 成功と失敗の両方のシナリオをテスト

## ベストプラクティス

### コンポーネントテスト
1. 実装詳細ではなく、ユーザーインタラクションをテスト
2. セマンティッククエリを使用（getByRole、getByText）
3. アクセシビリティ機能をテスト
4. 視覚的フィードバックと状態変更を検証

### APIテスト
1. 全HTTPメソッドとステータスコードをテスト
2. リクエスト/レスポンス形式を検証
3. エラー条件とエッジケースをテスト
4. 外部依存関係をモック

### データテスト
1. CRUD操作を徹底的にテスト
2. データ検証ルールを確認
3. 同時アクセスシナリオをテスト
4. データ整合性制約をチェック

## 継続的インテグレーション

### テスト自動化
- コード変更時にテストが自動実行
- 異なるコンポーネント用の分離されたテストスイート
- 重要なテスト失敗に対するフェイルファスト手法

### 品質ゲート
- 最小テストカバレッジ要件
- デプロイ前に全テストが合格必須
- パフォーマンス回帰テスト

## テストのデバッグ

### 一般的な問題
- パス解決の問題 → `vitest.config.ts` のエイリアスを確認
- モックセットアップの問題 → モック実装が実際のAPIと一致するか確認
- 非同期操作のタイミング → 適切な `waitFor` と `findBy` クエリを使用

### ツール
- インタラクティブデバッグ用 Vitest UI
- React Testing Library デバッグユーティリティ
- 状態検査用コンソールログ

## 今後の拡張

### 予定されている追加機能
1. ビジュアル回帰テスト
2. アクセシビリティテストの自動化
3. AIモデル切り替えの負荷テスト
4. クロスブラウザ互換性テスト
5. モバイルレスポンシブテスト

### テストデータ管理
- テストデータベースシーディングの実装
- 再利用可能なテストフィクスチャの作成
- エッジケース用プロパティベーステストの追加

## テスト結果例

### 現在の状況
```
テストファイル: 5個
- server/test/storage.test.ts: ✅ 11/11 合格
- server/test/routes.test.ts: 🔄 9/13 合格
- client/src/test/components/: 🔄 24/29 合格

合計: 44/53 テスト合格 (83%)
```

### 主要な成功領域
- データストレージ操作 (100%)
- APIエンドポイント基本機能 (69%)
- コンポーネントレンダリング (83%)

### 改善が必要な領域
- モックレスポンス形式の調整
- スタイリングアサーションの最適化
- エラーハンドリングテストの強化